@model Reina.MacCredy.Models.Product
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@inject SignInManager<ApplicationUser> SignInManager

<div class="container mt-4">
    <div class="card shadow-lg p-4 mt-3">
        <div class="row">
            <!-- Product Image -->
            <div class="col-md-4 text-center">
                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <img src="@Model.ImageUrl" alt="Product Image" class="img-fluid rounded shadow-sm" style="max-width: 250px;">
                }
                else
                {
                    <p class="text-muted">No image available</p>
                }
            </div>

            <!-- Product Information -->
            <div class="col-md-8">
                <h2 class="mb-3">@Model.Name</h2>
                
                <!-- Rating Display -->
                <div class="mb-3">
                    @{
                        double avgRating = Model.Reviews != null && Model.Reviews.Any() 
                            ? Math.Round(Model.Reviews.Average(r => r.Rating), 1) 
                            : 0;
                        int ratingCount = Model.Reviews != null ? Model.Reviews.Count : 0;
                    }
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                            @for (int i = 1; i <= 5; i++)
                            {
                                if (i <= Math.Floor(avgRating))
                                {
                                    <i class="bi bi-star-fill text-warning"></i>
                                }
                                else if (i - avgRating > 0 && i - avgRating < 1)
                                {
                                    <i class="bi bi-star-half text-warning"></i>
                                }
                                else
                                {
                                    <i class="bi bi-star text-warning"></i>
                                }
                            }
                        </div>
                        <span class="text-muted">@avgRating.ToString("0.0") (@ratingCount @(ratingCount == 1 ? "review" : "reviews"))</span>
                    </div>
                </div>
                
                <h4 class="text-primary">Price: @Model.Price.ToString("#,##0") Vnđ</h4>
                <p class="mt-3">@Model.Description</p>

                <div class="mt-4">
                    <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">⬅ Back to Home</a>
                    
                    <!-- Add to Cart button -->
                    <a asp-controller="ShoppingCart" asp-action="AddToCart" asp-route-id="@Model.Id" class="btn btn-primary">
                        <i class="bi bi-cart-plus"></i> Add to Cart
                    </a>
                    
                    <!-- Admin-only buttons -->
                    @if (User.IsInRole("Admin"))
                    {
                        <a asp-action="Update" asp-route-id="@Model.Id" class="btn btn-warning">✏ Edit</a>
                        <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger"
                           onclick="return confirm('Are you sure you want to delete this product?');">
                            🗑 Delete
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reviews Section -->
    <div class="card shadow-lg p-4 mt-4">
        <h3 class="mb-4">Customer Reviews</h3>
        
        <!-- Review Form -->
        @if (SignInManager.IsSignedIn(User))
        {
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Write a Review</h5>
                </div>
                <div class="card-body">
                    @if (ViewBag.HasOrdered == true || User.IsInRole("Admin"))
                    {
                        <form asp-action="AddReview" method="post">
                            <input type="hidden" name="productId" value="@Model.Id" />
                            
                            <div class="mb-3">
                                <label class="form-label">Rating</label>
                                <div class="rating-input d-flex">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="rating" id="rating@(i)" value="@i" required>
                                            <label class="form-check-label" for="rating@(i)">
                                                <i class="bi bi-star-fill text-warning"></i> @i
                                            </label>
                                        </div>
                                    }
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Your Review</label>
                                <textarea class="form-control" name="comment" rows="3" required></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Submit Review</button>
                        </form>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            You can only review products that you have purchased.
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-info mb-4">
                Please <a asp-area="Identity" asp-page="/Account/Login">sign in</a> to leave a review.
            </div>
        }
        
        <!-- Review List -->
        <div class="reviews-container">
            @if (Model.Reviews != null && Model.Reviews.Any())
            {
                foreach (var review in Model.Reviews.OrderByDescending(r => r.CreatedAt))
                {
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <h5 class="mb-0">@review.User.FullName</h5>
                                    <div class="text-muted small">
                                        @review.CreatedAt.ToString("MMMM dd, yyyy")
                                    </div>
                                </div>
                                <div>
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= review.Rating)
                                        {
                                            <i class="bi bi-star-fill text-warning"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-star text-warning"></i>
                                        }
                                    }
                                </div>
                            </div>
                            <p class="mb-0">@review.Comment</p>
                            
                            @if (User.IsInRole("Admin") || User.FindFirstValue(ClaimTypes.NameIdentifier) == review.UserId)
                            {
                                <div class="mt-2 text-end">
                                    <form asp-action="DeleteReview" method="post" style="display: inline-block;">
                                        <input type="hidden" name="reviewId" value="@review.Id" />
                                        <input type="hidden" name="productId" value="@Model.Id" />
                                        <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                onclick="return confirm('Are you sure you want to delete this review?');">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </form>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="alert alert-light">
                    No reviews yet. Be the first to review this product!
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // JavaScript to handle the rating selection UI
        document.addEventListener('DOMContentLoaded', function () {
            const ratingInputs = document.querySelectorAll('input[name="rating"]');
            
            // Highlight stars on hover
            ratingInputs.forEach(input => {
                input.addEventListener('change', function() {
                    const rating = parseInt(this.value);
                    
                    ratingInputs.forEach((inp, index) => {
                        const label = inp.nextElementSibling;
                        const star = label.querySelector('i');
                        
                        if (index < rating) {
                            star.classList.add('text-warning');
                        } else {
                            star.classList.remove('text-warning');
                        }
                    });
                });
            });
        });
    </script>
}
